<!DOCTYPE html>
<html lang="ko" itemscope itemtype="http://schema.org/WebPage"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout.html}">


<!-- Content -->
<div layout:fragment="content">
    <div class="col-12">
        <form action="/user/shop/list" method="get">
            <select class="form-control" id="category1" name="category1_no">
                <option th:text="전체보기" th:value="0"></option>
                <th:block th:each=" category : ${category.category1VOList}">
                    <option th:text="${category.category1_type}" th:value="${category.category1_no}"></option>
                </th:block>
            </select>
            <select class="form-control" id="category_sort" name="category_sort">
                <option th:text="등록일순" th:value="등록일순"></option>
                <option th:text="판매량순" th:value="판매량순"></option>
                <option th:text="낮은가격순" th:value="낮은가격순"></option>
                <option th:text="높은가격순" th:value="높은가격순"></option>
                <option th:text="리뷰많은순" th:value="리뷰많은순"></option>
                <option th:text="리뷰평점순" th:value="리뷰평점순"></option>
            </select>
            <button type="submit" id="submitBtn" class="" hidden="hidden">검색</button>
        </form>
    </div>
    <div class="col-12">
        <div class="card m-4">
            <div class="card-body p-0">
                <div id="carouselExampleCaptions" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <th:block th:each="productScoreList : ${productScoreList}">
                            <div class="carousel-item" id="carousel-item">
                                <a th:href="@{|/user/shop/detail/${productScoreList.product_no}|}">
                                    <th:block th:if="${productScoreList.mediaVO != null}">
                                        <img th:src="@{|/testimg/${productScoreList.mediaVO.media_path}|}"
                                             class="d-block w-100 border-radius-xl" alt="..." width="378" height="233"
                                             onerror="this.onerror=null; this.src='/assets/img/noimg.jpg';">
                                    </th:block>
                                    <th:block th:unless="${productScoreList.mediaVO != null}">
                                        <img src="/assets/img/No-image-found.jpg" class="d-block w-100 border-radius-xl"
                                             alt="..."
                                             width="378" height="233">
                                    </th:block>
                                </a>
                            </div>
                        </th:block>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleCaptions"
                            data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleCaptions"
                            data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="container px-3">
        <div class="row" id="productArea"></div>
        <div id="addProductArea"></div>
    </div>


    <script th:inline="javascript">
        /*<![CDATA[*/

        document.addEventListener('DOMContentLoaded', function () {
            // carousel Start ---------------------------------------------------------------------
            const firstCarouselItem = document.querySelector(".carousel-item:first-child");
            firstCarouselItem.classList.add("active");

            const carouselEl = document.querySelector('#carouselExampleCaptions');
            const carousel = new bootstrap.Carousel(carouselEl, {
                interval: 3000,
                pause: 'hover',
                wrap: true
            });
            // carousel End ---------------------------------------------------------------------

            // product list 불러오기  -------------------------
            getProductList();
        })


        let startIndex = 0;
        const productArea = document.getElementById('productArea');
        const addProductArea = document.getElementById('addProductArea');

        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    getProductList();
                }
            });
        });

        function isEmpty(obj) {
            // 객체가 아니거나 null일 경우 false 반환
            if (!obj || typeof obj !== 'object') {
                return false;
            }
            // 배열이나 객체의 length가 0인 경우 true 반환
            return Object.keys(obj).length === 0;
        }


        function getProductList() {
            const url = '/api/user/shop?category1_no=' + category1_no + '&category_sort=' + category_sort + '&startIndex=' + startIndex;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(response.statusText);
                    }
                    return response.json();
                }).then(list => {
                if (isEmpty(list)) {
                    observer.disconnect();
                } else {
                    load(list);
                    observer.observe(addProductArea);
                }
            }).catch(error => {
                console.error(error);
                alert("글 불러오기 실패");
            });
        }


        function load(list) {
            list.forEach(product => {
                loadProduct(product)
            })
        }

        function loadProduct(product) {

            const str = `<div class="col-6 mt-1 px-1">
                            <div class="card card-profile mt-md-0 shadow-none">
                                <a href="/user/shop/detail/${product.product_no}">
                                    <div class="p-3 pb-2">
                                        ${product.mediaVO != null ?
                                        `<img class="w-100 border-radius-md move-on-hover shadow-lg"
                                             src="/testimg/${product.mediaVO.media_path}" width="173"
                                             height="180" onerror="this.onerror=null; this.src='/assets/img/noimg.jpg';">` :
                                        `<img class="w-100 border-radius-md move-on-hover shadow-lg"
                                             src="/assets/img/df.png" width="173" height="180">`}
                                    </div>
                                </a>
                                <div class="card-body blur justify-content-center text-center p-1 mx-1 mb-3 border-radius-md">
                                    <p class="text-sm mb-1">${product.product_name}</p>
                                    <div class="row justify-content-center text-center">
                                        <div class="col-12 mx-auto">
                                            ${product.product_stock != 0 ?
                                            `<h5 class="jh-pink-title mb-0 text-sm">₩ ${product.product_price}</h5>` :
                                            `<h5 class="jh-pink-title mb-0 text-sm">SOLD OUT</h5>`}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;

            productArea.innerHTML += str;
            startIndex++;
        }

        // search Start ----------------------------------------------------------------------
        const select1 = document.getElementById('category1');
        const select2 = document.getElementById('category_sort');
        const urlParams = new URLSearchParams(window.location.search);
        let category1_no = urlParams.get('category1_no');
        let category_sort = urlParams.get('category_sort');

        if (category1_no) {
            select1.value = category1_no;
            select2.value = category_sort;
        }

        if (category1_no == null) {
            category1_no = 0;
            category_sort = "등록일순";
        }

        select1.addEventListener('change', function () {
            document.getElementById('submitBtn').click();
        })

        select2.addEventListener('change', function () {
            document.getElementById('submitBtn').click();
        })
        // search End ------------------------------------------------------------------------

        /*]]>*/
    </script>
</div>
<!-- End Content -->


</html>